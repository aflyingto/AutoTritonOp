name: Archive Artifacts

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      archive_type:
        description: 'Type of archive to create'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - source
          - wheel
          - docs

jobs:
  archive-source:
    runs-on: ubuntu-latest
    if: github.event.inputs.archive_type == 'all' || github.event.inputs.archive_type == 'source'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create source archive
      run: |
        git archive --format=tar.gz --prefix=autotritonops-${{ steps.version.outputs.version }}/ HEAD > autotritonops-${{ steps.version.outputs.version }}.tar.gz
        git archive --format=zip --prefix=autotritonops-${{ steps.version.outputs.version }}/ HEAD > autotritonops-${{ steps.version.outputs.version }}.zip

    - name: Calculate checksums
      run: |
        sha256sum autotritonops-${{ steps.version.outputs.version }}.tar.gz > SHA256SUMS.txt
        sha256sum autotritonops-${{ steps.version.outputs.version }}.zip >> SHA256SUMS.txt
        md5sum autotritonops-${{ steps.version.outputs.version }}.tar.gz > MD5SUMS.txt
        md5sum autotritonops-${{ steps.version.outputs.version }}.zip >> MD5SUMS.txt

    - name: Upload source archive (tar.gz)
      uses: actions/upload-artifact@v4
      with:
        name: source-tarball
        path: autotritonops-${{ steps.version.outputs.version }}.tar.gz
        retention-days: 90

    - name: Upload source archive (zip)
      uses: actions/upload-artifact@v4
      with:
        name: source-zip
        path: autotritonops-${{ steps.version.outputs.version }}.zip
        retention-days: 90

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums
        path: |
          SHA256SUMS.txt
          MD5SUMS.txt
        retention-days: 90

  archive-wheels:
    needs: build-wheel
    runs-on: ubuntu-latest
    if: github.event.inputs.archive_type == 'all' || github.event.inputs.archive_type == 'wheel'

    steps:
    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        path: dist/

    - name: Create wheel archive
      run: |
        tar -czf autotritonops-wheels.tar.gz dist/

    - name: Upload wheel archive
      uses: actions/upload-artifact@v4
      with:
        name: wheels-archive
        path: autotritonops-wheels.tar.gz
        retention-days: 90

  build-wheel:
    runs-on: ubuntu-latest
    if: github.event.inputs.archive_type == 'all' || github.event.inputs.archive_type == 'wheel'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools

    - name: Build wheel
      run: |
        python -m build

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels
        path: dist/*.whl
        retention-days: 90

  archive-docs:
    runs-on: ubuntu-latest
    if: github.event.inputs.archive_type == 'all' || github.event.inputs.archive_type == 'docs'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme myst-parser

    - name: Build documentation
      run: |
        mkdir -p docs/_build
        if [ -f "docs/conf.py" ]; then
          cd docs
          make html
          cd ..
        else
          echo "No documentation found, creating basic docs"
          mkdir -p docs/_build/html
          echo "<html><body><h1>AutoTritonOps Documentation</h1></body></html>" > docs/_build/html/index.html
        fi

    - name: Create docs archive
      run: |
        cd docs/_build/html
        tar -czf ../../../autotritonops-docs.tar.gz *

    - name: Upload docs archive
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: autotritonops-docs.tar.gz
        retention-days: 90

  create-release:
    needs: [archive-source, archive-wheels, archive-docs]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Upload release assets
      uses: softprops/action-gh-release-assets@v1
      with:
        files: |
          artifacts/source-tarball/*.tar.gz
          artifacts/source-zip/*.zip
          artifacts/wheels-archive/*.tar.gz
          artifacts/documentation/*.tar.gz
          artifacts/checksums/*.txt
        github-token: ${{ secrets.GITHUB_TOKEN }}

  create-summary:
    needs: [archive-source, archive-wheels, archive-docs]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "# Archive Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Source archives (tar.gz and zip)" >> $GITHUB_STEP_SUMMARY
        echo "- Wheel packages" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- Checksums (SHA256 and MD5)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Download Instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts are available in the GitHub Actions Artifacts section." >> $GITHUB_STEP_SUMMARY
        echo "They will be retained for 90 days." >> $GITHUB_STEP_SUMMARY
