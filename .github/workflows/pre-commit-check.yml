name: Pre-commit and Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  pre-commit-check:
    runs:
      on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Cache pre-commit
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

    - name: Run pre-commit
      run: |
        pre-commit run --all-files --show-diff-on-failure

  lint-python:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy pylint bandit

    - name: Run Black (code formatter)
      run: |
        black --check --diff ops/ test_accuracy.py_*.py

    - name: Run isort (import sorter)
      run: |
        isort --check-only --diff ops/ test_accuracy.py_*.py

    - name: Run Flake8 (linter)
      run: |
        flake8 ops/ test_accuracy.py_*.py --show-source --statistics

    - name: Run Bandit (security linter)
      run: |
        bandit -r ops/ test_accuracy.py_*.py -f json -o bandit-report.json || true
      continue-on-error: true

    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
        retention-days: 30

    - name: Run MyPy (type checker)
      run: |
        mypy ops/ --ignore-missing-imports --no-error-summary || true
      continue-on-error: true

  code-style-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for TODO/FIXME comments
      run: |
        if grep -r "TODO\|FIXME" ops/ test_accuracy.py_*.py; then
          echo "Warning: Found TODO or FIXME comments in the code"
          exit 1
        fi
      continue-on-error: true

    - name: Check line length
      run: |
        python3 -c "
import sys
max_line_length = 100
violations = []
for filename in ['ops/vector_add.py', 'ops/softmax.py', 'ops/layer_norm.py', 'ops/flash_attention.py', 'ops/matmul.py']:
    try:
        with open(filename, 'r') as f:
            for i, line in enumerate(f, 1):
                if len(line.rstrip()) > max_line_length:
                    violations.append(f'{filename}:{i}:{len(line.rstrip())}')
    except FileNotFoundError:
        pass

if violations:
    print(f'Found {len(violations)} lines exceeding {max_line_length} characters:')
    for v in violations[:10]:
        print(f'  {v}')
    if len(violations) > 10:
        print(f'  ... and {len(violations) - 10} more')
    sys.exit(1)
else:
    print('All lines are within the maximum length limit.')
        "

    - name: Check file encoding
      run: |
        for file in ops/*.py test_accuracy.py_*.py; do
          if [ -f "$file" ]; then
            file -i "$file" | grep -q "utf-8" || echo "Warning: $file is not UTF-8 encoded"
          fi
        done

  documentation-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install pydocstyle

    - name: Run pydocstyle (docstring style checker)
      run: |
        pydocstyle ops/ --convention=google || true
      continue-on-error: true

    - name: Check README
      run: |
        if [ ! -f "README.md" ]; then
          echo "Error: README.md not found"
          exit 1
        fi
        if [ $(wc -l < README.md) -lt 50 ]; then
          echo "Warning: README.md is too short"
        fi

  summary:
    needs: [pre-commit-check, lint-python, code-style-check, documentation-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Check results
      run: |
        echo "Pre-commit and Code Quality Checks Summary"
        echo "=========================================="
